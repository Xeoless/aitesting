<script>
  const API_TOKEN = "r8_ZY4fSfd86izQwtoQddI9EmPs12wDSaA2NvL2x";
  const CORS_PROXY = "https://corsproxy.io/?";

  const promptInput = document.getElementById('prompt');
  const generateBtn = document.getElementById('generateBtn');
  const status = document.getElementById('status');
  const imgElement = document.getElementById('generated-img');

  // Auto-focus prompt on load for better UX
  promptInput.focus();

  generateBtn.addEventListener('click', async () => {
    const userPrompt = promptInput.value.trim();
    if (!userPrompt) {
      alert("Yo, drop a description first!");
      return;
    }

    generateBtn.disabled = true;
    generateBtn.classList.add('loading'); // Optional: add spinner style if you define it in CSS
    status.textContent = "Generating epic thumbnail... hang tight (5-20 sec)";
    imgElement.style.display = "none";

    // Enhanced prompt with more Roblox/viral flair
    const fullPrompt = `High-converting Roblox thumbnail in viral style, ${userPrompt}, dramatic cinematic lighting, intense dynamic Roblox avatar pose, glowing neon effects, bold glowing text overlay with outline, explosive background, ultra detailed, high contrast vibrant colors, trending 2026 composition --ar 16:9`;

    try {
      // Step 1: Create prediction
      const createUrl = "https://api.replicate.com/v1/predictions";
      const createRes = await fetch(CORS_PROXY + encodeURIComponent(createUrl), {
        method: "POST",
        headers: {
          "Authorization": `Token ${API_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          version: "776f49aa0f1a009ac258a8d23d547add41a4a3e0a22d9d0070a9d120a470a4a4", // flux-schnell - still current/fast as of Jan 2026
          input: {
            prompt: fullPrompt,
            num_inference_steps: 4,
            aspect_ratio: "16:9"
          }
        })
      });

      if (!createRes.ok) {
        const errText = await createRes.text();
        throw new Error(`API error: ${createRes.status} - ${errText}`);
      }

      const { id } = await createRes.json();

      // Step 2: Poll
      let outputUrl = null;
      for (let i = 0; i < 40; i++) {
        await new Promise(r => setTimeout(r, 3000));

        const pollUrl = `https://api.replicate.com/v1/predictions/${id}`;
        const getRes = await fetch(CORS_PROXY + encodeURIComponent(pollUrl), {
          headers: { "Authorization": `Token ${API_TOKEN}` }
        });

        if (!getRes.ok) {
          const errText = await getRes.text();
          throw new Error(`Poll error: ${getRes.status} - ${errText}`);
        }

        const data = await getRes.json();

        if (data.status === "succeeded") {
          outputUrl = data.output?.[0];
          break;
        } else if (data.status === "failed" || data.error) {
          throw new Error(data.error || "Generation failed - check credits?");
        }

        status.textContent = `Still cooking... (${i + 1}/40)`;
      }

      if (outputUrl) {
        imgElement.src = outputUrl;
        imgElement.style.display = "block";
        status.textContent = "Boom! Thumbnail ready â€“ right-click to save ðŸ”¥";
      } else {
        throw new Error("Timed out â€“ try again or check replicate.com credits");
      }

    } catch (err) {
      status.textContent = "Oops: " + err.message;
      console.error(err);
    } finally {
      generateBtn.disabled = false;
      generateBtn.classList.remove('loading');
    }
  });
</script>
